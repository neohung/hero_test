<html>
  <head>
   <meta charset="UTF-8" />
   <title>標題</title>
   <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
   <script>
       var host = location.origin.replace(/^http/, 'ws')
       var ws = new WebSocket(host);
       var barsvg;
	   let data_array1 = new Array(10).fill(0);
	   let data_array2 = new Array(10).fill(0);
       function outputmsg(msg){
	     var li = document.createElement('li');
	     li.innerHTML = msg;
	     document.querySelector('#message').appendChild(li);		
       }
       function firstonload(){
	    //產生按鈕
	     d3.select("#d3btn").append("button").text("按鈕").on("click",function(){
	       //var host = location.origin.replace(/^http/, 'ws')
           //outputmsg(host)
		   //隨機產生資料
           data_array1 = data_array1.map(function(v, i){
		     //i=0,1,2~9
             return({x:i, y:Math.floor(Math.random()*100+1)});
           })
		   data_array2 = data_array2.map(function(v, i){
		     //i=0,1,2~9
             return({x:i, y:Math.floor(Math.random()*100+1)});
           })
	     })
		 //
		 pathsvg = d3.select("body").select('#neochart').append("svg");
	     //建立軸
	     pathsvg.append('g').attr("id", 'yAxis');
	     pathsvg.append('g').attr("id", 'xAxis');
		 //產生第一筆資料
		 data_array1 = data_array1.map(function(v, i){
           return({x:i, y:Math.floor(Math.random()*100+1)});
         })
		 data_array2 = data_array2.map(function(v, i){
           return({x:i, y:Math.floor(Math.random()*100+1)});
         })
	   }
      
 	   ws.onmessage = function (event) {
         var ran = Math.random();
         var time = (new Date()).getTime();
		 //outputmsg("time:" + time);
		 //設定畫布大小
         const height = 250;
         const width = 300;
         pathsvg.attr(
           'width', width,
          ).attr(
           'height', height,
          ).style(
           'border','2px solid black'
         );
		 //--------------------------------------------------
		 //domain和 range，對應就是 值域=>對應域, domain表示軸值為0~20, range表示由上到下長度有200格,
		 //var scaleY = d3.scale.linear().range([200, 0]).domain([0, d3.max(data_array, (d)=>d.val)]);
		 var scaleY = d3.scale.linear().range([200, 0]).domain([0, 100]);
	     var axisY = d3.svg.axis().scale(scaleY).orient("left").ticks(10);
		 pathsvg.select('#yAxis')
	     .attr("transform","translate(30,10)")	
	     .attr("class", "y axis")
	     .style("fill", "steelblue")
	     .call(axisY);
		 //--------------------------------------------------
		 //var scaleX = d3.scale.linear().range([0, 200]).domain([0, d3.max(data_array, (d)=>d.val)]);
		 var scaleX = d3.scale.linear().range([0, 200]).domain([0, 9]);
	     var axisX = d3.svg.axis().scale(scaleX).orient("bottom").ticks(10);
		 pathsvg.select('#xAxis')
	     .attr("transform","translate(35,220)")	
	     .attr("class", "x axis")
	     .style("fill", "steelblue")
		 .attr("font-family", "sans-serif")
         .attr("font-size", "8px")
	     .call(axisX);
		 //
		 //var tip = d3.tip().attr('class', 'd3-tip');
                          
		 //--------------------------------------------------
		 //產生d3 Line函數
		 var line = d3.svg.line().x(function(d) {
           return scaleX(d.x);
         }).y(function(d) {
           return scaleY(d.y);
         });
		 
		 function handleCircleMouseOver(d, i) { 
		   var host = location.origin.replace(/^http/, 'ws')
             d3.select(this).attr({
               fill: "orange",
               r: 4
             });
			 var tooltip = pathsvg.append("text");
			 tooltip.attr("id", 'tp')
			 .attr("font-family", "sans-serif")
             .attr("font-size", "12px")
		     .attr("x", scaleX(d.x)+30)
			 .attr("y", scaleY(d.y)-5)
			 .text(function() {

              return d.x+","+d.y;
            });
			 
		 }
		 function handleCircleMouseOut(d, i) {
		   d3.select("#tp").remove(); 
		 }
		 
		 //產生LINE1
		 var line1 = pathsvg.selectAll("#line1").data(data_array1);
		 line1.exit().remove(); //remove unneeded rect
         line1.enter().append("path"); //add new rect
		 line1.transition().duration(500)
		 .attr("id", 'line1')
		 .attr("stroke", 'blue')
		 .attr("fill", 'none')
		 .attr("transform", 'translate(35,0)') //offset
		 .attr("d", line(data_array1)); 
		 var line1cir = pathsvg.selectAll("#line1cir").data(data_array1);
		 line1cir.exit().remove(); //remove unneeded rect
         line1cir.enter().append("circle"); //add new rect
		 line1cir.transition().duration(500)
		 .attr("id", 'line1cir')
		 .attr("stroke", 'black')
		 .attr("stroke-width", 1)
		 .attr("fill", 'blue')
		 .attr('r', 3)
		 .attr("transform", 'translate(35,0)')
		 .attr('cx', function(d){return scaleX(d.x);})
		 .attr('cy', function(d){return scaleY(d.y);});
		 line1cir.on("mouseover", handleCircleMouseOver);
		 line1cir.on("mouseout", handleCircleMouseOut);
	 
		 //產生LINE2
		 var line2 = pathsvg.selectAll("#line2").data(data_array2);
		 line2.exit().remove(); //remove unneeded rect
         line2.enter().append("path"); //add new rect
		 line2.transition().duration(500)
		 .attr("id", 'line2')
		 .attr("stroke", 'red')
		 .attr("fill", 'none')
		 .attr("transform", 'translate(35,0)') //offset
		 .attr("d", line(data_array2));
		 var line2cir = pathsvg.selectAll("#line2cir").data(data_array2);
		 line2cir.exit().remove(); //remove unneeded rect
         line2cir.enter().append("circle"); //add new rect
		 line2cir.transition().duration(500)
		 .attr("id", 'line2cir')
		 .attr("stroke", 'black')
		 .attr("stroke-width", 1)
		 .attr("fill", 'red')
		 .attr('r', 3)
		 .attr("transform", 'translate(35,0)')
		 .attr('cx', function(d){return scaleX(d.x);})
		 .attr('cy', function(d){return scaleY(d.y);})
		 line2cir.on("mouseover", handleCircleMouseOver);
		 line2cir.on("mouseout", handleCircleMouseOut);
		 

/*		
		 //--------------------------------------------------
		 //產生BAR TEXT
		 var bartext = barsvg.selectAll('#barText').data(data_array);
		 bartext.exit().remove(); //remove unneeded rect
		 bartext.enter().append("text");
		 bartext.transition().duration(500)
		 .attr("id", 'barText')
         .attr("x", function(d){return d.val+35;})
         .attr("y", function(d){return 25+d.index*20;})
		 .attr("fill","blue")
         .attr("font-family", "sans-serif")
         .attr("font-size", "20px")
         .text(function(d){return d.val;}) 
		 .attr("class", "valText")
		 //tween表示補間動畫
		 .tween("valText", function(d){
		   let i = d3.interpolateRound(0, d.val);
           return (t)=>{
             //this.setAttribute("x",i(t)+10);
             this.textContent = i(t);
           }
		 });
		 */
       }
     //})
   </script>

  </head>
  <body onload="firstonload()">
    DATA
    <div id="neochart"></div>
	<br>
	<div id='d3btn'></div>
	<h1>Messages</h1>
    <ul id='message'></ul>
  </body>
</html>
